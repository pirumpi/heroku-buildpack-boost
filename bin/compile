#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

function error() {
  echo " !     $*" >&2
  exit 1
}

function topic() {
  echo "-----> $*"
}

function indent() {
  echo "       $*"
}

topic "Installing boost"
source $(dirname $0)/../config.sh

indent "BUILD_DIR: $BUILD_DIR"
indent "CACHE_DIR: $CACHE_DIR"
indent "LP_DIR: $LP_DIR"

VENDORED_BOOST="$BUILD_DIR/.boost/$BOOST_VERSION"

if [ ! -d "$VENDORED_BOOST" ]; then
  # Control will enter here if VENDORED_BOOST doesn't exist.
  indent "Download boost start $BOOST_DOWNLOAD_URL"
  mkdir -p "$VENDORED_BOOST"

  curl "$BOOST_DOWNLOAD_URL" -L -s -o - | tar xzf - -C "$VENDORED_BOOST"
  indent "Download boost end"

  cp user-config.jam $VENDORED_BOOST/boost_*/tools/build/example/

fi

# Prepend proper environment variables for Python use.
export PATH=/app/.heroku/python/bin:/app/.heroku/vendor/bin:$PATH
export PYTHONUNBUFFERED=1
export LANG=en_US.UTF-8
export C_INCLUDE_PATH=/app/.heroku/vendor/include:/app/.heroku/python/include:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=/app/.heroku/vendor/include:/app/.heroku/python/include:$CPLUS_INCLUDE_PATH
export LIBRARY_PATH=/app/.heroku/vendor/lib:/app/.heroku/python/lib:$LIBRARY_PATH
export LD_LIBRARY_PATH=/app/.heroku/vendor/lib:/app/.heroku/python/lib:$LD_LIBRARY_PATH
export PKG_CONFIG_PATH=/app/.heroku/vendor/lib/pkg-config:/app/.heroku/python/lib/pkg-config:$PKG_CONFIG_PATH


boost_lib_path="$BUILD_DIR/.heroku/vendor"
mkdir -p "$boost_lib_path"


testsetestset
cd $VENDORED_BOOST/boost_*

WITH_PYTHON="$BUILD_DIR/.heroku/python/bin/python3"
WITH_PYTHON_VERSION="3.6"
WITH_PYTHON_ROOT="$BUILD_DIR/.heroku/python/lib/python3.6"

export PYTHONHOME=$WITH_PYTHON:$PYTHONPATH


topic "./bootstrap.sh --with-libraries=python --prefix=$boost_lib_path --with-python=$WITH_PYTHON --with-python-version=$WITH_PYTHON_VERSION --with-python-root=$WITH_PYTHON_ROOT"

./bootstrap.sh --with-libraries=python --prefix=$boost_lib_path --with-python=$WITH_PYTHON --with-python-version=$WITH_PYTHON_VERSION --with-python-root=$WITH_PYTHON_ROOT
cat project-config.jam

./b2
./b2 install

topic "Writing profile script"
mkdir -p $BUILD_DIR/.profile.d
cat <<EOF >$BUILD_DIR/.profile.d/000_boost.sh
EOF

# Prepend proper environment variables for Python use.
export BOOST_ROOT="$boost_lib_path"
export BOOST_INCLUDEDIR="$boost_lib_path/include"
export BOOST_LIBRARYDIR="$boost_lib_path/lib"

#give environment to later buildpacks
export | grep -E -e ' (BOOST_ROOT|BOOST_INCLUDEDIR|BOOST_LIBRARYDIR)='  > "$LP_DIR/export"
