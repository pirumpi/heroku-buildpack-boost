#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2

PROFILE_PATH="$BUILD_DIR/.profile.d/boost.sh"
mkdir -p $(dirname $PROFILE_PATH)

source $(dirname $0)/../config.sh

function mktmpdir() {
  dir="$(mktemp -t $1-XXXX)"
  rm -rf "$dir"
  mkdir -p "$dir"
  echo "$dir"
}

function set-env() {
  echo "export $1=$2" >> $PROFILE_PATH
  source $PROFILE_PATH
}

boost_lib_path="/app/.heroku/vendor"
mkdir -p "$boost_lib_path"
VENDORED_BOOST="$(mktmpdir boost)"
curl "$BOOST_DOWNLOAD_URL" -L -s -o - | tar xzf - -C "$VENDORED_BOOST"
cd $VENDORED_BOOST/boost_*
./bootstrap.sh --with-libraries=python --prefix=$boost_lib_path
./b2
./b2 install

echo "CPLUS_INCLUDE_PATH : $boost_lib_path/lib:$boost_lib_path/include/boost:$CPLUS_INCLUDE_PATH"
set-env "CPLUS_INCLUDE_PATH" "$boost_lib_path/lib:$boost_lib_path/include/boost:$CPLUS_INCLUDE_PATH"

echo "LIBDIR : $boost_lib_path/lib:$boost_lib_path/include/boost:$LIBDIR"
set-env "LIBDIR" "$boost_lib_path/lib:$boost_lib_path/include/boost:$LIBDIR"

set-env "BOOST_ROOT" "$boost_lib_path/include/boost"
set-env "BOOST_LIBRARYDIR" "$boost_lib_path/lib"